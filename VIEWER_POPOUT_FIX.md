# Viewer Link and Popout Fix - Implementation Summary

## Problem
- Viewer links (Share link) returned Vercel 404 NOT_FOUND
- Popout windows returned Vercel 404 NOT_FOUND
- Both features worked locally but failed on Vercel deployment

## Root Cause
The `vercel.json` rewrite configuration was using regex syntax `(.*)` which may not have been processed correctly by Vercel. The rewrites weren't properly routing viewer and popout URLs to the SPA's `index.html`.

## Solution

### 1. Updated vercel.json Rewrites
Changed from regex syntax to Vercel's preferred `:path*` syntax:

**Before:**
```json
{
  "source": "/(.*)",
  "destination": "/index.html"
}
```

**After:**
```json
{
  "source": "/:path*",
  "destination": "/index.html"
}
```

This ensures all non-API routes are properly rewritten to `index.html` for SPA routing.

### 2. Added Debug Logging
Added comprehensive logging to help diagnose issues in production:

**linkHelpers.js:**
- `generateViewerLink()` now logs: roomId, baseUrl, window.origin, envUrl, and final viewerLink
- `openPopoutWindow()` now logs: roomId, baseUrl, window.origin, window.pathname, and popoutUrl

**StandaloneApp.jsx:**
- URL parsing logs: fullUrl, pathname, search, origin
- Parsed values logs: urlRoomId, urlHostKey, isPopout, asMode

These logs will appear in the browser console when:
- A user opens the Share modal (viewer link generation)
- A user clicks the Popout button (popout URL generation)
- The app loads (URL parsing)

## How It Works

### Viewer Link Flow
1. User clicks "Share" button in meeting
2. `ShareModal` displays viewer link generated by `generateViewerLink(roomId)`
3. Link format: `https://your-app.vercel.app/{roomId}`
4. When someone opens this link:
   - Vercel receives request for `/{roomId}`
   - `/:path*` rewrite matches and serves `/index.html`
   - React app loads
   - `StandaloneApp` parses `roomId` from `window.location.pathname`
   - App connects to room as viewer (no hostKey)

### Popout Flow
1. User clicks "Popout" button in meeting
2. `openPopoutWindow()` opens new window with URL: `https://your-app.vercel.app/{roomId}?popout=1&as=attendee&hostKey=...`
3. Vercel processes request:
   - `/:path*` rewrite matches and serves `/index.html`
   - React app loads in popup window
4. `StandaloneApp` detects:
   - `roomId` from pathname
   - `popout=1` query param → `isPopoutMode()` returns true
   - `as=attendee` query param → forces attendee view
5. App renders `PopoutView` component (compact view) instead of full UI

## Testing Instructions

### Manual Testing on Vercel

1. **Deploy and Create a Meeting:**
   - Deploy this branch to Vercel
   - Create a new meeting room
   - Note the room ID

2. **Test Viewer Link:**
   ```
   Open browser console (F12)
   Click "Share" button
   Check console for [DEBUG VIEWER LINK] output
   Copy the viewer link
   Open in incognito window
   Verify:
   - Page loads (no 404)
   - Console shows [DEBUG URL PARSING] and [DEBUG URL PARSED]
   - Meeting view loads as attendee
   - Timer and agenda are visible
   ```

3. **Test Popout:**
   ```
   From the same meeting, click "Popout" button
   Check console for [DEBUG POPOUT] output
   Verify:
   - New popup window opens (no 404)
   - Compact view renders with current item and timer
   - Timer stays in sync with main window
   ```

4. **Test API Routes (Regression Check):**
   ```
   In meeting, verify:
   - Timer controls work (Start/Pause/Reset)
   - Agenda items can be added/removed
   - Attendance updates in real-time
   
   Check browser Network tab:
   - WebSocket connection established
   - No 404 errors on /api/* endpoints
   ```

### Debug Log Examples

**Expected console output when generating viewer link:**
```
[DEBUG VIEWER LINK] {
  roomId: "abc123",
  baseUrl: "https://your-app.vercel.app",
  windowOrigin: "https://your-app.vercel.app",
  envUrl: "(not set)",
  viewerLink: "https://your-app.vercel.app/abc123"
}
```

**Expected console output when opening viewer link:**
```
[DEBUG URL PARSING] {
  fullUrl: "https://your-app.vercel.app/abc123",
  pathname: "/abc123",
  search: "",
  origin: "https://your-app.vercel.app"
}
[DEBUG URL PARSED] {
  urlRoomId: "abc123",
  urlHostKey: "(none)",
  isPopout: false,
  asMode: null
}
```

**Expected console output when opening popout:**
```
[DEBUG POPOUT] {
  roomId: "abc123",
  hostKey: "***",
  baseUrl: "https://your-app.vercel.app",
  windowOrigin: "https://your-app.vercel.app",
  windowPathname: "/abc123",
  popoutUrl: "https://your-app.vercel.app/abc123?popout=1&as=attendee&hostKey=***"
}

[DEBUG URL PARSING] {
  fullUrl: "https://your-app.vercel.app/abc123?popout=1&as=attendee&hostKey=***",
  pathname: "/abc123",
  search: "?popout=1&as=attendee&hostKey=***",
  origin: "https://your-app.vercel.app"
}
[DEBUG URL PARSED] {
  urlRoomId: "abc123",
  urlHostKey: "***",
  isPopout: true,
  asMode: "attendee"
}
```

## Cleanup After Verification

Once the fix is verified working in production:

1. Remove debug logging from `client/src/utils/linkHelpers.js`:
   - Remove console.log from `generateViewerLink()`
   - Remove console.log from `openPopoutWindow()`

2. Remove debug logging from `client/src/StandaloneApp.jsx`:
   - Remove both console.log calls from the URL parsing useEffect

3. Commit and deploy cleanup:
   ```bash
   git commit -am "Remove debug logging after viewer/popout fix verification"
   git push
   ```

## Technical Details

### Vercel Rewrite Processing Order
1. Serverless functions in `/api` directory (automatic)
2. Custom rewrites (in order specified)
3. Static files
4. 404

Our configuration:
1. `/health` → `/api/health`
2. `/proxy/health` → `/api/health`
3. `/proxy/api/:path*` → `/api/:path*`
4. `/:path*` → `/index.html` (SPA catch-all)

### Why This Fix Works
- Vercel's `:path*` syntax is more reliable than regex `(.*)`
- The catch-all rewrite `/:path*` properly handles any path (including `/{roomId}`)
- `/api` routes are handled automatically before rewrites, so they're not affected
- The order ensures specific routes (health, proxy) are handled first
