# Template Persistence Testing Guide

## Overview
This document provides comprehensive testing instructions for the agenda template persistence feature and UI layout fixes implemented in this PR.

## A) UI Box Cutoff Fix - Testing Instructions

### Issue Fixed
Panels (HostPanel, AttendancePanel) were being visually clipped at the bottom due to incorrect CSS flex layout constraints.

### What Was Changed
- Added `min-height: 0` to flex children in `.hostPanel`, `.hostPanelContent`, `.attendanceRail`, `.attendanceRailContent`, and `.mainContentGrid`
- Changed overflow-y from `scroll` to `auto` for better UX

### Manual Testing Steps

#### Test 1: Host Panel Scrolling
1. Open the app in standalone mode with host privileges
2. Add 15+ agenda items to fill the host panel
3. **Expected Result**: 
   - Host panel content scrolls smoothly with mouse wheel
   - No content is visually cut off
   - Scrollbar appears when content exceeds visible area
   - All agenda items are accessible

#### Test 2: Attendance Panel Scrolling
1. Open the app with 10+ participants
2. View the attendance rail (right panel)
3. **Expected Result**: 
   - All attendees are visible or scrollable
   - No names are cut off at the bottom
   - Mouse wheel scrolling works normally

#### Test 3: Different Screen Sizes
Test on the following resolutions:
- **1920x1080** (desktop)
- **1440x900** (laptop)
- **1366x768** (small laptop)

**Expected Result**: No clipping on any resolution, proper scrolling behavior maintained.

#### Test 4: Mobile/Responsive View
1. Resize browser to mobile width (< 768px)
2. **Expected Result**: 
   - Panels stack vertically
   - Each panel has appropriate max-height
   - Scrolling works in each panel independently

---

## B) Template Persistence - Testing Instructions

### Issue Fixed
Agenda templates were stored only in browser localStorage, causing them to be lost on:
- Browser data clearing
- Different devices/browsers
- New deployments (in some scenarios)

### What Was Changed
- Templates now stored in Cloudflare Durable Objects (server-side)
- WebSocket API for CRUD operations (TEMPLATE_SAVE, TEMPLATE_DELETE, TEMPLATE_LIST, TEMPLATE_IMPORT)
- Automatic migration from localStorage to server on first load
- Host-only permissions enforced

### Template Schema
```javascript
{
  id: "uuid-string",              // Generated by server
  name: "Template Name",          // User-provided
  createdAt: 1234567890,         // Timestamp
  updatedAt: 1234567890,         // Timestamp
  items: [                       // Array of agenda items
    {
      title: "Item Title",
      durationSec: 300,
      notes: "Optional notes",
      type: "regular|proposal",
      description: "Proposal description",
      link: "https://...",
      category: "Budget",
      onBallot: false
    }
  ]
}
```

### Manual Testing Steps

#### Test 1: Save Template
1. Open app in standalone mode as host
2. Create an agenda with 3-5 items (mix regular and proposal types)
3. Enter a template name in "Save as Template" field
4. Click "Save Template"
5. **Expected Result**: 
   - Success message or template appears in template list
   - Template has a unique ID
   - No error messages

#### Test 2: Load Template
1. In host panel, locate saved templates section
2. Click "Load" on a saved template
3. **Expected Result**: 
   - Template items are added to current agenda
   - All fields preserved (title, duration, notes, type, proposal fields)
   - No duplicate prevention (items append to agenda)

#### Test 3: Delete Template
1. Click "Delete" button on a template
2. **Expected Result**: 
   - Template removed from list
   - Confirmation or immediate removal
   - No error messages

#### Test 4: Empty Name Validation
1. Try to save a template with an empty name
2. **Expected Result**: 
   - Error message: "Template name is required"
   - Template not saved

#### Test 5: Host-Only Enforcement
1. Open app as an attendee (without host privileges)
2. Check template management UI
3. **Expected Result**: 
   - Attendees cannot see template save/delete buttons
   - OR attempts to save/delete return "host_only" error

#### Test 6: Persistence Across Refresh
1. Save a template named "Test Template 1"
2. Refresh the browser (F5)
3. Re-join the meeting
4. **Expected Result**: 
   - "Test Template 1" still appears in template list
   - All items and metadata intact

#### Test 7: Persistence Across Deployments
**Setup**: This requires access to deploy the app (or wait for automatic deployment)

1. Save 2-3 templates in the current deployment
2. Note template names and item counts
3. Deploy a new version of the app (push to main branch or redeploy on Vercel)
4. After deployment completes, open the app
5. Join the same meeting room
6. **Expected Result**: 
   - All saved templates still present
   - Names and items match original
   - No data loss

#### Test 8: localStorage Migration
**Setup**: Need templates in localStorage from old version

1. Open browser DevTools > Application > localStorage
2. Manually add old-format templates:
   ```javascript
   localStorage.setItem("agendaTemplates", JSON.stringify([
     {
       name: "Legacy Template",
       items: [
         { title: "Item 1", durationSec: 300, notes: "Test" }
       ]
     }
   ]));
   ```
3. Refresh page and join meeting
4. **Expected Result**: 
   - "Migrating templates" console message
   - TEMPLATE_IMPORT message sent to server
   - Templates appear in server list
   - localStorage migration flag set (prevents re-import)

#### Test 9: Import Templates from File
1. Export templates to JSON file using "Export Templates" button
2. Clear all templates (or use different room)
3. Click "Import Templates" and select the exported JSON file
4. **Expected Result**: 
   - Templates imported successfully
   - Appear in template list with new IDs
   - All items and fields intact

#### Test 10: Export Templates
1. Save 2-3 templates
2. Click "Export Templates" button
3. **Expected Result**: 
   - JSON file downloads
   - File contains array of templates
   - All fields present (name, items, etc.)

#### Test 11: Multiple Users - Isolation
1. User A (host) saves template "Template A"
2. User B (different room) saves template "Template B"
3. **Expected Result**: 
   - User A only sees "Template A"
   - User B only sees "Template B"
   - Templates are room-specific, not global

#### Test 12: Proposal Fields Preservation
1. Create agenda with proposal items (type="proposal")
2. Set description, link, category, onBallot fields
3. Save as template
4. Clear agenda
5. Load template
6. **Expected Result**: 
   - All proposal fields preserved
   - description, link, category, onBallot all correct
   - Proposal rendering works properly

#### Test 13: Error Handling
1. Try to trigger errors:
   - Network disconnection during save
   - Invalid template data
   - Server error response
2. **Expected Result**: 
   - User-friendly error message displayed
   - No silent failures
   - Console logs show error details

---

## Performance Testing

### Test 1: Large Template List
1. Create 20+ templates
2. Open host panel
3. **Expected Result**: 
   - Template list renders smoothly
   - Scrolling in template section works
   - No UI lag or freezing

### Test 2: Large Template Items
1. Create a template with 50+ agenda items
2. Save template
3. Load template
4. **Expected Result**: 
   - Save completes in < 2 seconds
   - Load completes in < 2 seconds
   - All items added correctly

---

## Regression Testing

Ensure these existing features still work:

1. **Agenda Management**
   - Add/edit/delete agenda items
   - Reorder items (drag & drop)
   - Set active item
   
2. **Timer Functions**
   - Start/pause/resume timer
   - Timer extends functionality
   - Overtime indication

3. **Voting System**
   - Open vote with custom question
   - Cast votes
   - Close vote and view results

4. **Meeting Setup**
   - Set meeting name
   - Start meeting
   - Host handoff/release

5. **Attendance Tracking**
   - Participants appear in attendance list
   - Online/offline status updates
   - Display names shown correctly

---

## Known Limitations

1. **Templates are room-specific**: Each meeting room has its own template storage
2. **No template sharing**: Templates cannot be shared between rooms (use export/import instead)
3. **No version control**: Template updates replace previous version (no history)
4. **ID-based deletion**: Old code using index-based deletion won't work (migration needed)

---

## Troubleshooting

### Issue: Templates not appearing after save
- Check browser console for errors
- Verify WebSocket connection is active
- Confirm host privileges (isHost = true)
- Check server logs for TEMPLATE_SAVE handler

### Issue: Templates lost after refresh
- Verify Durable Objects are enabled in wrangler.toml
- Check that MEETING_ROOM binding is configured
- Confirm room ID is consistent across sessions
- Review server logs for template storage errors

### Issue: Migration not working
- Check localStorage has templates (DevTools > Application)
- Verify migration flag not already set
- Check console for "Migrating templates" message
- Ensure TEMPLATE_IMPORT message is sent

### Issue: Scrolling not working in panels
- Clear browser cache
- Hard refresh (Ctrl+Shift+R)
- Check that new CSS is loaded (DevTools > Sources)
- Verify min-height: 0 is applied (DevTools > Elements)

---

## Security Verification

### Template Permissions
- ✅ Only host can save templates (enforced server-side)
- ✅ Only host can delete templates (enforced server-side)
- ✅ Only host can import templates (enforced server-side)
- ✅ Template list available to all (read-only for attendees)

### Data Validation
- ✅ Template names validated (not empty)
- ✅ Items validated as array
- ✅ All fields sanitized (String(), Number(), Boolean())
- ✅ No code injection vulnerabilities (CodeQL passed)

---

## Success Criteria

### UI Box Cutoff Fix
- ✅ No panels are visually clipped on any screen size
- ✅ Mouse wheel scrolling works in all scrollable areas
- ✅ Content can be accessed without keyboard arrow keys
- ✅ Scrollbars appear only when needed

### Template Persistence
- ✅ Templates survive browser refresh
- ✅ Templates survive deployment (Durable Objects)
- ✅ Templates survive localStorage clearing
- ✅ Host-only permissions enforced
- ✅ Migration from localStorage works
- ✅ All agenda fields preserved (including proposals)
- ✅ Error handling provides user feedback
- ✅ No security vulnerabilities introduced

---

## Deployment Checklist

Before deploying to production:

1. ✅ Code review completed
2. ✅ CodeQL security scan passed (0 vulnerabilities)
3. ✅ Build succeeds without errors
4. ✅ Manual testing completed for core features
5. [ ] Regression testing completed
6. [ ] Performance testing on large datasets
7. [ ] Cross-browser testing (Chrome, Firefox, Safari)
8. [ ] Mobile/responsive testing
9. [ ] Verify Durable Objects configured in production
10. [ ] Monitor server logs after deployment

---

## Rollback Plan

If issues are discovered after deployment:

1. Revert the PR commits
2. Redeploy previous version
3. Templates will remain in Durable Objects (safe)
4. Users may need to use localStorage export as backup

**Note**: Template data is preserved in Durable Objects, so reverting the code won't lose templates. However, the UI to access them would be unavailable until the fix is redeployed.
